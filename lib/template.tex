\documentclass[12pt,twoside]{extarticle}
\usepackage{enumitem}
\usepackage{geometry}
\usepackage{setspace}
\usepackage{fontspec}
\usepackage{graphicx}
\usepackage{lastpage}
\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=black,
    filecolor=black,
    urlcolor=blue,
    citecolor=black,
    pdftitle={$title$},
    pdfauthor={$author$},
    pdfsubject={$subtitle$},
    pdflang={fi},
}

\usepackage[utf8]{inputenc}
\usepackage[notes,backend=biber,language=finnish]{biblatex-chicago}

% Bibliography formatting
\addbibresource{$bibliography$}
\DeclareLanguageMapping{finnish}{finnish-apa}
\DeclareLanguageMapping{finnish}{finnish-chicago}

% Set bibliography spacing
\setlength{\bibhang}{2em}
\setlength{\bibitemsep}{1.5\itemsep}

\newcounter{wordcount}
\graphicspath{{.}}  % Look for images in current directory
\setmainfont{Linux Libertine}

% Set default line spacing to 1.5
\onehalfspacing
\usepackage{fancyhdr}

% Custom footnote and page breaking settings
\usepackage[bottom,multiple,stable]{footmisc}
\renewcommand{\footnoterule}{%
    \vspace*{0.1cm}%
    \hrule width \textwidth height 0.4pt%
    \vspace*{0.1cm}%
}
\interfootnotelinepenalty=9000
\makeatletter
\renewcommand\@makefntext[1]{%
    \parindent0.5em
    \hspace*{-0.5em}\makebox[1.5em][r]{\@thefnmark.}\hspace{0.5em}%
    \parbox[t]{\dimexpr\linewidth-1.5em\relax}{#1}}
\makeatother
\setlength{\footnotesep}{1em}  % Space between footnotes
\setlength{\skip\footins}{2em}   % Space between text and footnotes
\setlength{\dimen\footins}{20\baselineskip}  % Max height for footnotes
\raggedbottom  % Allows some flexibility in page breaking
\interfootnotelinepenalty=10000
\interlinepenalty=5000
\widowpenalty=7500
\clubpenalty=7500
\tolerance=1000
\brokenpenalty=10000
\emergencystretch=1em

% Macros for chapter titles
\newcommand{\chaptertitlestart}{\vspace*{0.2cm}}
\newcommand{\chaptertitlestop}{\vspace*{0.1cm}}

% Page layout
\geometry{a4paper, margin=3.5cm}

% Page numbering and header setup
\pagestyle{fancy}
\fancyhf{} % Clear all header and footer fields

% Remove chapter numbering from header
\renewcommand{\sectionmark}[1]{\markboth{\MakeUppercase{#1}}{}}
\renewcommand{\subsectionmark}[1]{\markright{\MakeUppercase{#1}}}

% Apply headers
\fancyhead[RE]{\leftmark}
\fancyhead[LO]{\leftmark}
\fancyfoot[RE]{{\fontsize{14pt}{16.8pt}\selectfont\thepage}}  % 2pt increase (12pt -> 14pt)
\fancyfoot[LO]{{\fontsize{14pt}{16.8pt}\selectfont\thepage}}  % 2pt increase (12pt -> 14pt)
\renewcommand{\headrulewidth}{0.4pt} % Add a line under the header

\begin{document}

% Remove page numbers from first pages
\pagenumbering{gobble}

% Cover page
\begin{titlepage}
\thispagestyle{empty}

% Logo
\vspace*{-2cm}  % Move up to counter page margin
\hspace*{-2.5cm}  % Move left to counter page margin
\includegraphics[width=3cm]{logo.jpg}
\vspace*{1cm}

\vspace*{2cm}

\begin{center}
    \Huge
    \textbf{$title$}
    
    \vspace{0.5cm}
    
    \Large
    $subtitle$
\end{center}

\vfill

{
\setstretch{0.75}  % Tighter spacing for cover page
\begin{flushright}
    \large
    $school$ \\
    $studies$ \\
    $direction$ \\
    \vspace{1cm}
    $tyon_tyyppi$ \\
    $author$ \\
    \vspace{1cm}
    $date$ \\
    $place$
\end{flushright}
}

\end{titlepage}

% Document details page
\newpage
\thispagestyle{plain}

% Skip page numbering
\pagenumbering{gobble}

% Dirty fix for Roman page numbering
\fancyhf{} % Clear ALL previous settings
\fancyhead[RE]{\leftmark}
\fancyhead[LO]{\leftmark}
\fancyfoot[LE]{{\fontsize{14pt}{16.8pt}\selectfont\thepage}}
\fancyfoot[RO]{{\fontsize{14pt}{16.8pt}\selectfont\thepage}}

% First section of table
\begin{tabular}{|p{0.75\textwidth}|p{0.25\textwidth}|}
\hline

% Second section of table
\multicolumn{2}{|p{\textwidth}|}{%
    \begin{minipage}[t]{\dimexpr\textwidth-2\tabcolsep\relax}
        \begin{tabular}{p{0.36\textwidth}p{0.367\textwidth}p{0.273\textwidth}}
            {\footnotesize Sivumäärä:} & {\footnotesize Sanamäärä:} & {\footnotesize Lukuaika:} \\
            \pageref{LastPage} & $wordcount$ & $readingtime$ min
        \end{tabular}
    \end{minipage}
} \\ \hline

{\footnotesize Laatijan nimi} & {\footnotesize Opiskelijanumero} \\
$author$ & $opiskelijanumero$ \\ \hline
{\footnotesize Työn nimi} & {\footnotesize Päivämäärä} \\
$title$ & $date$ \\ \hline
{\footnotesize Opintojakson nimi} & {\footnotesize Opintojakso} \\
$opintojakson_nimi$ & $opintojakso$ \\ \hline
{\footnotesize Opintokokonaisuuden nimi} & {\footnotesize Opintokokonaisuus} \\
$opintokokonaisuus_nimi$ & $opintokokonaisuus$ \\ \hline

% Last section of table
\multicolumn{2}{|l|}{{\footnotesize Lisätiedot}} \\
\multicolumn{2}{|p{\textwidth}|}{%
    \begin{minipage}[t][\dimexpr\textheight-7.5cm\relax][t]{\dimexpr\textwidth-2\tabcolsep\relax}
        $lisatiedot$
    \end{minipage}
} \\ \hline
\end{tabular}
\clearpage

% Table of Contents page
\renewcommand{\contentsname}{SISÄLLYSLUETTELO}
\renewcommand{\refname}{LÄHDELUETTELO}

% Modify TOC style
\makeatletter
\renewcommand{\@dotsep}{2}
\renewcommand{\numberline}[1]{#1\hspace{1em}}
\renewcommand{\l@section}{\@dottedtocline{1}{0em}{2.5em}}
\renewcommand{\l@subsection}{\@dottedtocline{2}{2.5em}{2.5em}}
\renewcommand{\l@subsubsection}{\@dottedtocline{3}{5em}{2.5em}}
\makeatother

$if(toc)$
% Start Roman page numbering
\pagenumbering{Roman}
\setcounter{page}{1}

% Add TOC
\tableofcontents
\clearpage
$endif$

% Add bibliography
% TODO:
%\defbibheading{kirj}{\section*{Kirjallisuus}}
%\defbibheading{vira}{\section*{Virallislähteet}}
%\defbibheading{oikt}{\section*{Oikeustapaukset}}

%\printbibliography[heading=kirj,type=book]
%\printbibliography[heading=none,type=inbook]
%\printbibliography[heading=none,type=collection]
%\printbibliography[heading=none,type=incollection]

%\printbibliography[heading=oikt,type=jurisdiction]
%\printbibliography[heading=oikt,type=legal]

%\printbibliography
%\clearpage

% Start page numbering
\pagenumbering{arabic}
\setcounter{page}{1}

% Revert dirty fix for Roman page numbering
\fancyhf{} % Clear ALL previous settings again
\fancyhead[RE]{\leftmark}
\fancyhead[LO]{\leftmark}
\fancyfoot[RE]{{\fontsize{14pt}{16.8pt}\selectfont\thepage}}
\fancyfoot[LO]{{\fontsize{14pt}{16.8pt}\selectfont\thepage}}

% Set main text font size (default 14pt if not specified)
{\fontsize{$if(font)$$font$pt$else$14pt$endif$}{$if(font)$\dimexpr1.2\dimexpr$font$pt\relax\relax$else$16.8pt$endif$}\selectfont
$body$
}

\end{document}
